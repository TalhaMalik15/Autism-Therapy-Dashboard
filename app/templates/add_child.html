<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Child - TherapyTrack</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <div class="logo-icon">ðŸŒˆ</div>
                <span class="logo-text">TherapyTrack</span>
            </a>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/doctor/dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="/doctor/add-child" class="active">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Child</span>
                </a>
            </li>
            <li>
                <a href="/doctor/dashboard">
                    <i class="fas fa-child"></i>
                    <span>My Children</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-calendar-check"></i>
                    <span>Sessions</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </li>
            <li style="margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                <a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="/doctor/dashboard" class="btn btn-ghost btn-icon">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="page-title">Add New Child</h1>
                    <p class="page-subtitle">Create a new child profile and optionally link a parent</p>
                </div>
            </div>
        </div>

        <div class="card animate-fadeInUp" style="max-width: 800px;">
            <div class="card-body" style="padding: 40px;">
                <form id="addChildForm">
                    <!-- Child Information Section -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--text-primary);">
                            <span style="width: 35px; height: 35px; background: var(--primary-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem;">1</span>
                            Child Information
                        </h3>
                        
                        <div class="form-group">
                            <label class="form-label">Child's Full Name *</label>
                            <input type="text" class="form-input" id="childName" placeholder="Enter child's full name" required>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label class="form-label">Age *</label>
                                <input type="number" class="form-input" id="childAge" placeholder="Age in years" min="1" max="18" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender *</label>
                                <select class="form-select" id="childGender" required>
                                    <option value="">Select gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Diagnosis *</label>
                            <select class="form-select" id="childDiagnosis" required>
                                <option value="">Select diagnosis</option>
                                <option value="ASD">Autism Spectrum Disorder (ASD)</option>
                                <option value="Asperger">Asperger's Syndrome</option>
                                <option value="PDD-NOS">PDD-NOS</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-textarea" id="additionalNotes" placeholder="Any additional information about the child..."></textarea>
                        </div>
                    </div>

                    <!-- Parent Information Section -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--text-primary);">
                            <span style="width: 35px; height: 35px; background: var(--secondary-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem;">2</span>
                            Parent Information (Optional)
                        </h3>

                        <div style="background: rgba(79, 172, 254, 0.1); border-radius: var(--border-radius-md); padding: 20px; margin-bottom: 25px;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <i class="fas fa-info-circle" style="color: var(--info-color); margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600; margin-bottom: 5px;">Auto Parent Account Creation</p>
                                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                                        If you enter a parent email that doesn't exist in the system, a new parent account will be automatically created and login credentials will be sent via email.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Parent's Name</label>
                            <input type="text" class="form-input" id="parentName" placeholder="Enter parent's name">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label class="form-label">Parent's Email</label>
                                <input type="email" class="form-input" id="parentEmail" placeholder="parent@email.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parent's Phone</label>
                                <input type="tel" class="form-input" id="parentPhone" placeholder="+1 234 567 8900">
                            </div>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <a href="/doctor/dashboard" class="btn btn-ghost">Cancel</a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus-circle"></i>
                            Create Child Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="modal-overlay" id="successModal">
            <div class="modal" style="text-align: center;">
                <div class="modal-body" style="padding: 50px 30px;">
                    <div style="width: 80px; height: 80px; background: var(--secondary-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; font-size: 2rem;">
                        <i class="fas fa-check" style="color: white;"></i>
                    </div>
                    <h2 style="margin-bottom: 15px; color: var(--text-primary);">Child Profile Created! ðŸŽ‰</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 25px;">The child profile has been successfully created.</p>
                    
                    <div style="background: var(--bg-primary); border-radius: var(--border-radius-md); padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Child Code:</p>
                        <p id="generatedChildCode" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color); font-family: monospace; letter-spacing: 2px;">P-2025-0000</p>
                    </div>

                    <div id="parentCreatedMessage" style="display: none; background: rgba(56, 239, 125, 0.1); border-radius: var(--border-radius-md); padding: 15px; margin-bottom: 25px;">
                        <p style="color: #11998e;">
                            <i class="fas fa-envelope"></i>
                            Parent account created! Login credentials sent via email.
                        </p>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <a href="/doctor/dashboard" class="btn btn-outline">
                            Back to Dashboard
                        </a>
                        <button class="btn btn-primary" onclick="location.reload()">
                            Add Another Child
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');

        if (!token || userType !== 'doctor') {
            window.location.href = '/login';
        }

        // Form submission
        document.getElementById('addChildForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const childData = {
                name: document.getElementById('childName').value,
                age: parseInt(document.getElementById('childAge').value),
                gender: document.getElementById('childGender').value,
                diagnosis: document.getElementById('childDiagnosis').value,
                parent_name: document.getElementById('parentName').value || null,
                parent_email: document.getElementById('parentEmail').value || null,
                parent_phone: document.getElementById('parentPhone').value || null
            };

            try {
                const response = await fetch('/api/doctor/create-child', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(childData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    document.getElementById('generatedChildCode').textContent = data.child_code;
                    
                    if (data.parent_created) {
                        document.getElementById('parentCreatedMessage').style.display = 'block';
                    }

                    document.getElementById('successModal').classList.add('active');
                } else {
                    showToast(data.detail || 'Failed to create child profile', 'error');
                }
            } catch (error) {
                showToast('Connection error. Please try again.', 'error');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });
    </script>
</body>
</html>
