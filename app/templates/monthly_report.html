<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Report - TherapyTrack</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .report-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 20px;
            padding: 40px;
            color: white;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        .report-header h1,
        .report-header p,
        .report-header span {
            color: white !important;
            opacity: 1 !important;
        }
        .report-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .print-btn {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-neutral { color: var(--warning-color); }
        .milestone-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
        }
        .milestone-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
        }
        .comparison-table th, .comparison-table td {
            padding: 15px;
            text-align: center;
        }
        .comparison-table .improved { background: rgba(17, 153, 142, 0.1); }
        .comparison-table .declined { background: rgba(235, 87, 87, 0.1); }
        @media print {
            .sidebar, .print-btn, .btn { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 20px !important; }
        }
        
        /* PDF Export Styles */
        .pdf-mode .main-content {
            margin-left: 0 !important;
            padding: 20px !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        .pdf-mode .sidebar,
        .pdf-mode .print-btn,
        .pdf-mode .no-print {
            display: none !important;
        }
        .pdf-mode .report-header {
            border-radius: 12px !important;
            margin: 0 0 20px 0 !important;
            padding: 25px !important;
            page-break-inside: avoid;
        }
        /* Keep stats in grid layout */
        .pdf-mode .stats-grid {
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important;
            gap: 12px !important;
            margin-bottom: 20px !important;
        }
        .pdf-mode .stat-card {
            box-shadow: none !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 12px !important;
            padding: 12px !important;
            page-break-inside: avoid;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            background: white !important;
        }
        .pdf-mode .stat-card .stat-icon {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            border-radius: 10px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .pdf-mode .stat-card .stat-content h3 {
            font-size: 1.3rem !important;
            margin: 0 0 2px 0 !important;
            color: #1a1a2e !important;
        }
        .pdf-mode .stat-card .stat-content p {
            font-size: 0.75rem !important;
            margin: 0 !important;
            color: #6b7280 !important;
        }
        .pdf-mode .card,
        .pdf-mode .milestone-card {
            box-shadow: none !important;
            border: 1px solid #e0e0e0 !important;
            page-break-inside: avoid;
            margin-bottom: 15px !important;
            border-radius: 12px !important;
        }
        .pdf-mode .charts-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 20px !important;
        }
        .pdf-mode h1, .pdf-mode h2, .pdf-mode h3 {
            page-break-after: avoid;
        }
        .pdf-mode .chart-container {
            page-break-inside: avoid;
            max-height: 300px !important;
        }
        .pdf-mode canvas {
            max-height: 280px !important;
        }
        .pdf-mode table {
            page-break-inside: avoid;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar no-print">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <div class="logo-icon">ðŸŒˆ</div>
                <span class="logo-text">TherapyTrack</span>
            </a>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" id="dashboardLink"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li><a href="#" class="active"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
            <li style="margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Report Header -->
        <div class="report-header animate-fadeInUp">
            <div class="print-btn" style="display: flex; gap: 10px;">
                <button class="btn" onclick="downloadPDF()" style="background: white; color: #11998e; font-weight: 600; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn" onclick="window.print()" style="background: rgba(255,255,255,0.2); color: white; font-weight: 600; border: 2px solid white; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
            <div style="position: relative; z-index: 1;">
                <p style="color: rgba(255,255,255,0.95); margin-bottom: 8px; font-size: 1rem; font-weight: 500;"><i class="fas fa-calendar-alt"></i> Monthly Progress Report</p>
                <h1 style="font-size: 2.5rem; margin-bottom: 12px; color: white; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.15);" id="childName">Loading...</h1>
                <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">
                    <span id="reportMonth">-</span> | Generated: <span id="generatedDate">-</span>
                </p>
            </div>
        </div>

        <!-- Monthly Overview Stats -->
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card primary animate-fadeInUp">
                <div class="stat-icon primary"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-content">
                    <h3 id="totalSessions">0</h3>
                    <p>Total Sessions</p>
                </div>
            </div>
            <div class="stat-card success animate-fadeInUp delay-100">
                <div class="stat-icon success"><i class="fas fa-clock"></i></div>
                <div class="stat-content">
                    <h3 id="totalHours">0h</h3>
                    <p>Total Hours</p>
                </div>
            </div>
            <div class="stat-card warning animate-fadeInUp delay-200">
                <div class="stat-icon warning"><i class="fas fa-percentage"></i></div>
                <div class="stat-content">
                    <h3 id="attendance">0%</h3>
                    <p>Attendance</p>
                </div>
            </div>
            <div class="stat-card info animate-fadeInUp delay-300">
                <div class="stat-icon info"><i class="fas fa-chart-line"></i></div>
                <div class="stat-content">
                    <h3 id="avgProgress">0%</h3>
                    <p>Avg Progress</p>
                </div>
            </div>
            <div class="stat-card primary animate-fadeInUp delay-400">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);"><i class="fas fa-trophy"></i></div>
                <div class="stat-content">
                    <h3 id="milestones">0</h3>
                    <p>Milestones</p>
                </div>
            </div>
        </div>

        <!-- Milestones Achieved -->
        <div class="card animate-fadeInUp delay-500" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3 style="margin: 0;"><i class="fas fa-trophy"></i> Milestones Achieved This Month</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <div class="milestone-card">
                        <div class="milestone-icon"><i class="fas fa-comments"></i></div>
                        <h4>First Conversation</h4>
                        <p style="opacity: 0.8; font-size: 0.9rem;">Initiated a 3-turn conversation</p>
                    </div>
                    <div class="milestone-card" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                        <div class="milestone-icon"><i class="fas fa-users"></i></div>
                        <h4>Group Play</h4>
                        <p style="opacity: 0.8; font-size: 0.9rem;">Participated in group activity</p>
                    </div>
                    <div class="milestone-card" style="background: linear-gradient(135deg, #f2994a, #f2c94c);">
                        <div class="milestone-icon"><i class="fas fa-utensils"></i></div>
                        <h4>Independent Eating</h4>
                        <p style="opacity: 0.8; font-size: 0.9rem;">Ate meal without assistance</p>
                    </div>
                    <div class="milestone-card" style="background: linear-gradient(135deg, #eb5757, #ff6b6b);">
                        <div class="milestone-icon"><i class="fas fa-heart"></i></div>
                        <h4>Emotion Recognition</h4>
                        <p style="opacity: 0.8; font-size: 0.9rem;">Identified 5 basic emotions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div class="card animate-fadeInUp delay-600">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-chart-line"></i> Progress Trend (4 Weeks)</h3>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="100"></canvas>
                </div>
            </div>
            <div class="card animate-fadeInUp delay-700">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-chart-pie"></i> Session Distribution</h3>
                </div>
                <div class="card-body">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Week-by-Week Comparison -->
        <div class="card animate-fadeInUp delay-800" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3 style="margin: 0;"><i class="fas fa-exchange-alt"></i> Weekly Comparison</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="data-table comparison-table">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Week 1</th>
                                <th>Week 2</th>
                                <th>Week 3</th>
                                <th>Week 4</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong><i class="fas fa-comments"></i> Communication</strong></td>
                                <td>65%</td>
                                <td>68%</td>
                                <td>70%</td>
                                <td class="improved">72%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +7%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-heart"></i> Emotional</strong></td>
                                <td>58%</td>
                                <td>60%</td>
                                <td>63%</td>
                                <td class="improved">65%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +7%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-users"></i> Social</strong></td>
                                <td>70%</td>
                                <td>73%</td>
                                <td>75%</td>
                                <td class="improved">78%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +8%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-hand-peace"></i> Behavior</strong></td>
                                <td>62%</td>
                                <td>65%</td>
                                <td>66%</td>
                                <td class="improved">68%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +6%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-brain"></i> Cognitive</strong></td>
                                <td>70%</td>
                                <td>72%</td>
                                <td>73%</td>
                                <td class="improved">75%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +5%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-hand-sparkles"></i> Sensory</strong></td>
                                <td>52%</td>
                                <td>53%</td>
                                <td>54%</td>
                                <td>55%</td>
                                <td><span class="trend-neutral"><i class="fas fa-arrows-alt-h"></i> +3%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-home"></i> Daily Living</strong></td>
                                <td>75%</td>
                                <td>78%</td>
                                <td>80%</td>
                                <td class="improved">82%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +7%</span></td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-star"></i> Participation</strong></td>
                                <td>65%</td>
                                <td>67%</td>
                                <td>68%</td>
                                <td class="improved">70%</td>
                                <td><span class="trend-up"><i class="fas fa-arrow-up"></i> +5%</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Goals & Next Month Plan -->
        <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div class="card animate-fadeInUp delay-900">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-bullseye"></i> Goals Status</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Improve eye contact during conversations</span>
                            <span class="badge badge-success"><i class="fas fa-check"></i> Achieved</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill success" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Follow 3-step instructions</span>
                            <span class="badge badge-success"><i class="fas fa-check"></i> Achieved</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill success" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Participate in group activities</span>
                            <span class="badge badge-warning"><i class="fas fa-clock"></i> In Progress</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill warning" style="width: 75%;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Independent hand washing</span>
                            <span class="badge badge-warning"><i class="fas fa-clock"></i> In Progress</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill warning" style="width: 60%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card animate-fadeInUp delay-1000">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-forward"></i> Next Month Focus</h3>
                </div>
                <div class="card-body">
                    <div style="background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-hand-sparkles"></i> Priority: Sensory Processing</h4>
                        <p style="color: var(--text-secondary);">Increase sensory integration activities from 2 to 4 sessions per week. Focus on tactile and vestibular activities.</p>
                    </div>
                    <div style="background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: var(--success-color); margin-bottom: 10px;"><i class="fas fa-users"></i> Continue: Social Skills</h4>
                        <p style="color: var(--text-secondary);">Build on group activity success. Introduce peer interaction exercises and collaborative games.</p>
                    </div>
                    <div style="background: var(--bg-light); border-radius: 12px; padding: 20px;">
                        <h4 style="color: var(--warning-color); margin-bottom: 10px;"><i class="fas fa-flag"></i> New Goal</h4>
                        <p style="color: var(--text-secondary);">Start working on independent dressing skills and morning routine completion.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Doctor Notes -->
        <div class="card animate-fadeInUp" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3 style="margin: 0;"><i class="fas fa-user-md"></i> Therapist Notes</h3>
            </div>
            <div class="card-body">
                <div style="background: linear-gradient(135deg, #f5f7fa, #e4e8eb); border-radius: 15px; padding: 25px; border-left: 5px solid var(--primary-color);">
                    <p style="font-style: italic; line-height: 1.8; color: var(--text-secondary);" id="therapistNotes">
                        "This month has shown remarkable progress across multiple domains. The child demonstrates increased engagement during sessions and shows genuine interest in social interactions. Communication skills have improved significantly, with more spontaneous verbal initiations observed. I recommend continuing the current therapy intensity while adding more sensory integration activities. The family's consistent home practice has been instrumental in this progress."
                    </p>
                    <p style="margin-top: 15px; font-weight: 600;">â€” <span id="therapistName">Dr. Therapist</span></p>
                </div>
            </div>
        </div>

        <!-- Report Actions -->
        <div style="text-align: center; margin-top: 30px;" class="no-print">
            <a href="#" id="weeklyReportLink" class="btn btn-outline btn-lg">
                <i class="fas fa-calendar-week"></i> View Weekly Report
            </a>
            <button class="btn btn-primary btn-lg" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button class="btn btn-secondary btn-lg" onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> Download PDF
            </button>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');
        const childId = window.location.pathname.split('/').pop();

        if (!token) {
            window.location.href = '/login';
        }

        // Set links
        document.getElementById('dashboardLink').href = userType === 'doctor' ? '/doctor/dashboard' : '/parent/dashboard';
        document.getElementById('weeklyReportLink').href = `/reports/weekly/${childId}`;

        // Set dates
        const today = new Date();
        const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        document.getElementById('reportMonth').textContent = monthName;
        document.getElementById('generatedDate').textContent = today.toLocaleDateString();

        // Load report data
        async function loadReport() {
            try {
                const childRes = await fetch(`/api/child/${childId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (childRes.ok) {
                    const child = await childRes.json();
                    document.getElementById('childName').textContent = child.name;
                }

                const reportRes = await fetch(`/api/reports/monthly/${childId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (reportRes.ok) {
                    const report = await reportRes.json();
                    document.getElementById('totalSessions').textContent = report.total_sessions || 0;
                    const hours = Math.round((report.total_duration || 0) / 60);
                    document.getElementById('totalHours').textContent = `${hours}h`;
                    document.getElementById('attendance').textContent = `${report.attendance || 95}%`;
                    document.getElementById('avgProgress').textContent = `${report.average_progress || 71}%`;
                    document.getElementById('milestones').textContent = report.milestones || 4;
                }
            } catch (error) {
                console.error('Error loading report:', error);
            }

            initCharts();
        }

        function initCharts() {
            // Trend Line Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Communication',
                            data: [65, 68, 70, 72],
                            borderColor: '#667eea',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Social',
                            data: [70, 73, 75, 78],
                            borderColor: '#11998e',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Daily Living',
                            data: [75, 78, 80, 82],
                            borderColor: '#f2994a',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Sensory',
                            data: [52, 53, 54, 55],
                            borderColor: '#eb5757',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Pie Chart
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Communication', 'Motor Skills', 'Social', 'Cognitive', 'Sensory'],
                    datasets: [{
                        data: [25, 20, 20, 20, 15],
                        backgroundColor: [
                            '#667eea',
                            '#11998e',
                            '#f2994a',
                            '#9b59b6',
                            '#eb5757'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        async function downloadPDF() {
            showToast('Generating PDF...', 'info');
            
            const childName = document.getElementById('childName').textContent;
            const reportMonth = document.getElementById('reportMonth').textContent;
            const generatedDate = document.getElementById('generatedDate').textContent;
            const totalSessions = document.getElementById('totalSessions').textContent;
            const totalHours = document.getElementById('totalHours').textContent;
            const attendance = document.getElementById('attendance').textContent;
            const avgProgress = document.getElementById('avgProgress').textContent;
            const milestones = document.getElementById('milestones').textContent;
            const doctorName = localStorage.getItem('userName') || 'Doctor';
            
            // Create professional invoice-style PDF content
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; background: white;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #11998e; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #11998e, #38ef7d); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ðŸŒˆ</div>
                                <div>
                                    <h1 style="margin: 0; font-size: 24px; color: #1a1a2e; font-weight: 700;">TherapyTrack</h1>
                                    <p style="margin: 0; font-size: 12px; color: #6b7280;">Autism Therapy Management System</p>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0 0 5px 0; font-size: 20px; color: #11998e; font-weight: 600;">MONTHLY PROGRESS REPORT</h2>
                            <p style="margin: 0; font-size: 12px; color: #6b7280;">Report #MR-${Date.now().toString().slice(-6)}</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Generated: ${generatedDate}</p>
                        </div>
                    </div>
                    
                    <!-- Patient & Doctor Info -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; gap: 40px;">
                        <div style="flex: 1; background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #11998e;">
                            <h3 style="margin: 0 0 12px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px;">Patient Information</h3>
                            <p style="margin: 0 0 6px 0; font-size: 18px; font-weight: 600; color: #1a1a2e;">${childName}</p>
                            <p style="margin: 0; font-size: 13px; color: #6b7280;">Report Period: ${reportMonth}</p>
                        </div>
                        <div style="flex: 1; background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                            <h3 style="margin: 0 0 12px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px;">Therapist Information</h3>
                            <p style="margin: 0 0 6px 0; font-size: 18px; font-weight: 600; color: #1a1a2e;">Dr. ${doctorName}</p>
                            <p style="margin: 0; font-size: 13px; color: #6b7280;">Licensed Therapy Specialist</p>
                        </div>
                    </div>
                    
                    <!-- Summary Stats -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #1a1a2e; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Monthly Summary</h3>
                        <div style="display: flex; gap: 12px;">
                            <div style="flex: 1; background: linear-gradient(135deg, #667eea15, #667eea05); padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #667eea30;">
                                <p style="margin: 0; font-size: 26px; font-weight: 700; color: #667eea;">${totalSessions}</p>
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">Sessions</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #11998e15, #11998e05); padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #11998e30;">
                                <p style="margin: 0; font-size: 26px; font-weight: 700; color: #11998e;">${totalHours}</p>
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">Total Hours</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #f39c1215, #f39c1205); padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #f39c1230;">
                                <p style="margin: 0; font-size: 26px; font-weight: 700; color: #f39c12;">${attendance}</p>
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">Attendance</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #3b82f615, #3b82f605); padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #3b82f630;">
                                <p style="margin: 0; font-size: 26px; font-weight: 700; color: #3b82f6;">${avgProgress}</p>
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">Progress</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #9b59b615, #9b59b605); padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #9b59b630;">
                                <p style="margin: 0; font-size: 26px; font-weight: 700; color: #9b59b6;">${milestones}</p>
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">Milestones</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Domain Progress -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #1a1a2e; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Domain Progress Analysis</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Domain</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Score</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Progress</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Communication Skills</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #11998e;">85%</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"><div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden; width: 150px;"><div style="background: #11998e; height: 100%; width: 85%;"></div></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #11998e;">â†‘ Improving</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Social Skills</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #11998e;">78%</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"><div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden; width: 150px;"><div style="background: #667eea; height: 100%; width: 78%;"></div></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #11998e;">â†‘ Improving</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Behavioral Management</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #f39c12;">72%</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"><div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden; width: 150px;"><div style="background: #f39c12; height: 100%; width: 72%;"></div></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #6b7280;">â†’ Stable</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Cognitive Development</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #11998e;">80%</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"><div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden; width: 150px;"><div style="background: #3b82f6; height: 100%; width: 80%;"></div></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #11998e;">â†‘ Improving</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">Sensory Processing</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #11998e;">75%</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"><div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden; width: 150px;"><div style="background: #9b59b6; height: 100%; width: 75%;"></div></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #11998e;">â†‘ Improving</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Recommendations -->
                    <div style="margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #1a1a2e; font-weight: 600;">Recommendations for Next Month</h3>
                        <ul style="margin: 0; padding: 0 0 0 20px; color: #374151; font-size: 13px; line-height: 1.8;">
                            <li>Continue focus on communication exercises</li>
                            <li>Increase social interaction activities</li>
                            <li>Maintain current behavioral strategies</li>
                            <li>Introduce new sensory integration techniques</li>
                        </ul>
                    </div>
                    
                    <!-- Footer -->
                    <div style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">This report is generated by TherapyTrack System</p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">For questions, contact your therapy provider.</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="border-top: 1px solid #1a1a2e; padding-top: 8px; width: 200px;">
                                    <p style="margin: 0; font-size: 12px; font-weight: 600; color: #1a1a2e;">Dr. ${doctorName}</p>
                                    <p style="margin: 2px 0 0 0; font-size: 11px; color: #6b7280;">Authorized Signature</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `Monthly_Report_${childName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };
            
            try {
                await html2pdf().set(opt).from(pdfContent).save();
                showToast('PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('Error generating PDF. Please try again.', 'error');
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        loadReport();
    </script>
</body>
</html>
