<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - TherapyTrack</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <div class="logo-icon">ðŸŒˆ</div>
                <span class="logo-text">TherapyTrack</span>
            </a>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/doctor/dashboard" class="active"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li><a href="/doctor/add-child"><i class="fas fa-user-plus"></i><span>Add Child</span></a></li>
            <li><a href="/doctor/my-children"><i class="fas fa-child"></i><span>My Children</span></a></li>
            <li><a href="/doctor/sessions"><i class="fas fa-calendar-check"></i><span>Sessions</span></a></li>
            <li><a href="/doctor/reports"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
            <li style="margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Welcome back, <span id="doctorName">Doctor</span>! ðŸ‘‹</h1>
                <p class="page-subtitle">Here's what's happening with your patients today.</p>
            </div>
            <a href="/doctor/add-child" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Child
            </a>
        </div>

        <!-- Stats Cards -->
        <div class="doctor-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card primary animate-fadeInUp">
                <div class="stat-icon primary"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <h3 id="totalChildren">0</h3>
                    <p>Total Children</p>
                </div>
            </div>
            <div class="stat-card success animate-fadeInUp delay-100">
                <div class="stat-icon success"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-content">
                    <h3 id="todaySessions">0</h3>
                    <p>Today's Sessions</p>
                </div>
            </div>
            <div class="stat-card warning animate-fadeInUp delay-200">
                <div class="stat-icon warning"><i class="fas fa-calendar-week"></i></div>
                <div class="stat-content">
                    <h3 id="weekSessions">0</h3>
                    <p>This Week</p>
                </div>
            </div>
            <div class="stat-card info animate-fadeInUp delay-300">
                <div class="stat-icon info"><i class="fas fa-chart-line"></i></div>
                <div class="stat-content">
                    <h3 id="avgProgress">85%</h3>
                    <p>Avg. Progress</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card animate-fadeInUp delay-400" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3 style="margin: 0;"><i class="fas fa-bolt" style="color: var(--warning-color); margin-right: 10px;"></i>Quick Actions</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <a href="/doctor/add-child" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add New Child
                    </a>
                    <a href="/doctor/sessions" class="btn btn-secondary">
                        <i class="fas fa-play-circle"></i> Start Session
                    </a>
                    <a href="/doctor/reports" class="btn btn-outline">
                        <i class="fas fa-file-alt"></i> Generate Report
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Children List -->
            <div class="card animate-fadeInUp delay-500">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;"><i class="fas fa-child" style="color: var(--primary-color); margin-right: 10px;"></i>My Children</h3>
                    <a href="#" class="btn btn-ghost btn-sm">View All</a>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Child</th>
                                    <th>Code</th>
                                    <th>Age</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="childrenTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--text-secondary);"></i>
                                        <p style="margin-top: 10px; color: var(--text-secondary);">Loading children...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card animate-fadeInUp delay-600">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-history" style="color: var(--secondary-color); margin-right: 10px;"></i>Recent Activity</h3>
                </div>
                <div class="card-body" id="recentActivity">
                    <div style="text-align: center; padding: 30px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--text-secondary);"></i>
                        <p style="margin-top: 10px; color: var(--text-secondary);">Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div class="card animate-fadeInUp delay-700">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-chart-pie" style="color: var(--info-color); margin-right: 10px;"></i>Domain Progress</h3>
                </div>
                <div class="card-body">
                    <canvas id="domainChart"></canvas>
                </div>
            </div>
            <div class="card animate-fadeInUp delay-800">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-chart-line" style="color: var(--success-color); margin-right: 10px;"></i>Weekly Sessions</h3>
                </div>
                <div class="card-body">
                    <canvas id="sessionsChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');
        let allChildren = [];

        if (!token || userType !== 'doctor') {
            window.location.href = '/login';
        }

        const userName = localStorage.getItem('userName');
        document.getElementById('doctorName').textContent = userName || 'Doctor';

        // Load all children once
        async function loadAllChildren() {
            try {
                const response = await fetch('/api/doctor/children', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    allChildren = await response.json();
                }
            } catch (error) {
                console.error('Error loading children:', error);
            }
            return allChildren;
        }

        async function loadDashboard() {
            try {
                const statsResponse = await fetch('/api/doctor/dashboard-stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalChildren').textContent = stats.total_children;
                    document.getElementById('todaySessions').textContent = stats.todays_sessions;
                    document.getElementById('weekSessions').textContent = stats.weeks_sessions;

                    if (stats.recent_activity && stats.recent_activity.length > 0) {
                        const activityHtml = stats.recent_activity.map((activity, index) => `
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px 0; ${index < stats.recent_activity.length - 1 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                                <div class="avatar" style="background: var(--primary-gradient);">${activity.child_name[0]}</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">${activity.child_name}</p>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary);">Session on ${new Date(activity.date).toLocaleDateString()}</p>
                                </div>
                                <span class="badge badge-primary">${activity.duration} min</span>
                            </div>
                        `).join('');
                        document.getElementById('recentActivity').innerHTML = activityHtml;
                    } else {
                        document.getElementById('recentActivity').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-history" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p style="font-weight: 500;">No recent activity</p>
                                <p style="font-size: 0.85rem; margin-top: 5px;">Sessions will appear here</p>
                            </div>
                        `;
                    }
                }

                // Load children for table and store globally
                await loadAllChildren();
                
                if (allChildren.length > 0) {
                    const tableHtml = allChildren.slice(0, 5).map(child => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="avatar" style="width: 36px; height: 36px; font-size: 0.9rem;">${child.name[0]}</div>
                                    <div>
                                        <strong>${child.name}</strong>
                                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;">${child.gender}</p>
                                    </div>
                                </div>
                            </td>
                            <td><span class="child-code">${child.child_code}</span></td>
                            <td>${child.age} yrs</td>
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-ghost btn-sm btn-icon" onclick="window.location.href='/doctor/view-child/${child.id}'" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-ghost btn-sm btn-icon" onclick="window.location.href='/doctor/add-session/${child.id}'" title="Add Session">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                    document.getElementById('childrenTableBody').innerHTML = tableHtml;
                } else {
                    document.getElementById('childrenTableBody').innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 50px;">
                                <i class="fas fa-user-plus" style="font-size: 2.5rem; color: var(--text-light); margin-bottom: 15px; display: block;"></i>
                                <p style="color: var(--text-secondary); font-weight: 500; margin-bottom: 5px;">No children yet</p>
                                <p style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 20px;">Add your first child to get started</p>
                                <a href="/doctor/add-child" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Child</a>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        function initCharts() {
            const domainCtx = document.getElementById('domainChart').getContext('2d');
            new Chart(domainCtx, {
                type: 'radar',
                data: {
                    labels: ['Communication', 'Emotional', 'Social', 'Behavior', 'Cognitive', 'Sensory', 'Daily Living', 'Participation'],
                    datasets: [{
                        label: 'Average Progress',
                        data: [75, 68, 82, 70, 78, 65, 85, 72],
                        fill: true,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 20 } } },
                    plugins: { legend: { display: false } }
                }
            });

            const sessionsCtx = document.getElementById('sessionsChart').getContext('2d');
            new Chart(sessionsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Sessions',
                        data: [3, 5, 4, 6, 4, 2, 3],
                        borderColor: '#11998e',
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        loadDashboard();
        initCharts();
    </script>
</body>
</html>
