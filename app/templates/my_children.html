<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Children - TherapyTrack</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <div class="logo-icon">ðŸŒˆ</div>
                <span class="logo-text">TherapyTrack</span>
            </a>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/doctor/dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li><a href="/doctor/add-child"><i class="fas fa-user-plus"></i><span>Add Child</span></a></li>
            <li><a href="/doctor/my-children" class="active"><i class="fas fa-child"></i><span>My Children</span></a></li>
            <li><a href="/doctor/sessions"><i class="fas fa-calendar-check"></i><span>Sessions</span></a></li>
            <li><a href="/doctor/reports"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
            <li style="margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title"><i class="fas fa-child" style="color: var(--primary-color); margin-right: 15px;"></i>My Children</h1>
                <p class="page-subtitle">View and manage all your patients</p>
            </div>
            <a href="/doctor/add-child" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Child
            </a>
        </div>

        <!-- Search and Filter Section -->
        <div class="card" style="margin-bottom: 25px;">
            <div class="card-body">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 300px; position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                        <input type="text" id="searchInput" placeholder="Search by child code (e.g., P-2025-1234) or name..." 
                               style="width: 100%; padding: 12px 15px 12px 45px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 0.95rem;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <select id="genderFilter" style="padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 0.95rem; min-width: 120px;">
                            <option value="">All Genders</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                        <select id="sortBy" style="padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 0.95rem; min-width: 150px;">
                            <option value="name">Sort by Name</option>
                            <option value="age">Sort by Age</option>
                            <option value="sessions">Sort by Sessions</option>
                            <option value="recent">Recently Added</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="stats-grid" style="margin-bottom: 25px;">
            <div class="stat-card primary">
                <div class="stat-icon primary"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <h3 id="totalCount">0</h3>
                    <p>Total Children</p>
                </div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon success"><i class="fas fa-user-check"></i></div>
                <div class="stat-content">
                    <h3 id="maleCount">0</h3>
                    <p>Male</p>
                </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon warning"><i class="fas fa-user-check"></i></div>
                <div class="stat-content">
                    <h3 id="femaleCount">0</h3>
                    <p>Female</p>
                </div>
            </div>
            <div class="stat-card info">
                <div class="stat-icon info"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-content">
                    <h3 id="totalSessions">0</h3>
                    <p>Total Sessions</p>
                </div>
            </div>
        </div>

        <!-- Children List -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;"><i class="fas fa-list" style="color: var(--primary-color); margin-right: 10px;"></i>Children List</h3>
                <span id="resultCount" style="color: var(--text-secondary); font-size: 0.9rem;">Loading...</span>
            </div>
            <div class="card-body" style="padding: 0;">
                <div id="childrenContainer">
                    <div style="text-align: center; padding: 50px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-secondary);"></i>
                        <p style="margin-top: 15px; color: var(--text-secondary);">Loading children...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');

        if (!token || userType !== 'doctor') {
            window.location.href = '/login';
        }

        let allChildren = [];

        async function loadChildren() {
            try {
                const response = await fetch('/api/doctor/children', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    allChildren = await response.json();
                    updateStats();
                    renderChildren(allChildren);
                } else {
                    showToast('Error loading children', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading children', 'error');
            }
        }

        function updateStats() {
            const maleCount = allChildren.filter(c => c.gender === 'Male').length;
            const femaleCount = allChildren.filter(c => c.gender === 'Female').length;
            const totalSessions = allChildren.reduce((sum, c) => sum + (c.session_count || 0), 0);

            document.getElementById('totalCount').textContent = allChildren.length;
            document.getElementById('maleCount').textContent = maleCount;
            document.getElementById('femaleCount').textContent = femaleCount;
            document.getElementById('totalSessions').textContent = totalSessions;
        }

        function filterAndSort() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            const genderFilter = document.getElementById('genderFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = allChildren.filter(child => {
                const matchesSearch = !searchQuery || 
                    child.name.toLowerCase().includes(searchQuery) || 
                    child.child_code.toLowerCase().includes(searchQuery);
                const matchesGender = !genderFilter || child.gender === genderFilter;
                return matchesSearch && matchesGender;
            });

            // Sort
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'age': return b.age - a.age;
                    case 'sessions': return (b.session_count || 0) - (a.session_count || 0);
                    case 'recent': return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                    default: return 0;
                }
            });

            renderChildren(filtered);
        }

        function renderChildren(children) {
            document.getElementById('resultCount').textContent = `${children.length} children found`;

            if (children.length === 0) {
                document.getElementById('childrenContainer').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <i class="fas fa-search" style="font-size: 3rem; color: var(--text-light); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No children found</h3>
                        <p style="color: var(--text-light);">Try adjusting your search or filters</p>
                        <a href="/doctor/add-child" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Add New Child
                        </a>
                    </div>
                `;
                return;
            }

            const html = `
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Child</th>
                            <th>Child Code</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Sessions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${children.map(child => `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="avatar" style="width: 45px; height: 45px; font-size: 1.1rem;">${child.name[0]}</div>
                                        <div>
                                            <strong style="font-size: 1rem;">${child.name}</strong>
                                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 3px;">
                                                ${child.diagnosis || 'No diagnosis specified'}
                                            </p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="child-code" style="font-size: 0.9rem; padding: 6px 12px;">${child.child_code}</span>
                                </td>
                                <td>
                                    <span style="font-weight: 500;">${child.age}</span> years
                                </td>
                                <td>
                                    <span class="badge ${child.gender === 'Male' ? 'badge-primary' : 'badge-warning'}">
                                        <i class="fas fa-${child.gender === 'Male' ? 'mars' : 'venus'}"></i> ${child.gender}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-success">${child.session_count || 0} sessions</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-primary btn-sm" onclick="window.location.href='/doctor/view-child/${child.id}'" title="View Profile">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="window.location.href='/doctor/add-session/${child.id}'" title="Add Session">
                                            <i class="fas fa-plus"></i> Session
                                        </button>
                                        <button class="btn btn-outline btn-sm" onclick="window.location.href='/reports/weekly/${child.id}'" title="View Reports">
                                            <i class="fas fa-chart-bar"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('childrenContainer').innerHTML = html;
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterAndSort);
        document.getElementById('genderFilter').addEventListener('change', filterAndSort);
        document.getElementById('sortBy').addEventListener('change', filterAndSort);

        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        // Initialize
        loadChildren();
    </script>
</body>
</html>
