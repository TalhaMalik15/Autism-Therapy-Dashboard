<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Report - TherapyTrack</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 40px;
            color: white;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        .report-header h1,
        .report-header p,
        .report-header span {
            color: white !important;
            opacity: 1 !important;
        }
        .report-header .subtitle {
            color: rgba(255,255,255,0.9) !important;
        }
        .report-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .report-header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        .print-btn {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .domain-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        .domain-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .domain-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        .rating-good { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .rating-average { background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; }
        .rating-needs-work { background: linear-gradient(135deg, #eb5757, #ff6b6b); color: white; }
        .summary-box {
            background: linear-gradient(135deg, #f5f7fa, #e4e8eb);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .recommendation-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow-sm);
        }
        @media print {
            .sidebar, .print-btn, .btn { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 20px !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        }
        
        /* PDF Export Styles */
        .pdf-mode .main-content {
            margin-left: 0 !important;
            padding: 20px !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        .pdf-mode .sidebar,
        .pdf-mode .print-btn,
        .pdf-mode .no-print {
            display: none !important;
        }
        .pdf-mode .report-header {
            border-radius: 12px !important;
            margin: 0 0 20px 0 !important;
            padding: 25px !important;
            page-break-inside: avoid;
        }
        /* Keep stats in grid layout */
        .pdf-mode .stats-grid {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 15px !important;
            margin-bottom: 20px !important;
        }
        .pdf-mode .stat-card {
            box-shadow: none !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 12px !important;
            padding: 15px !important;
            page-break-inside: avoid;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            background: white !important;
        }
        .pdf-mode .stat-card .stat-icon {
            width: 45px !important;
            height: 45px !important;
            min-width: 45px !important;
            border-radius: 10px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .pdf-mode .stat-card .stat-content h3 {
            font-size: 1.5rem !important;
            margin: 0 0 2px 0 !important;
            color: #1a1a2e !important;
        }
        .pdf-mode .stat-card .stat-content p {
            font-size: 0.8rem !important;
            margin: 0 !important;
            color: #6b7280 !important;
        }
        .pdf-mode .card,
        .pdf-mode .domain-card {
            box-shadow: none !important;
            border: 1px solid #e0e0e0 !important;
            page-break-inside: avoid;
            margin-bottom: 15px !important;
            border-radius: 12px !important;
        }
        .pdf-mode .charts-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 20px !important;
        }
        .pdf-mode h1, .pdf-mode h2, .pdf-mode h3 {
            page-break-after: avoid;
        }
        .pdf-mode .chart-container {
            page-break-inside: avoid;
            max-height: 300px !important;
        }
        .pdf-mode canvas {
            max-height: 280px !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar no-print">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <div class="logo-icon">üåà</div>
                <span class="logo-text">TherapyTrack</span>
            </a>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" id="dashboardLink"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li><a href="#" class="active"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
            <li style="margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Report Header -->
        <div class="report-header animate-fadeInUp">
            <div class="print-btn" style="display: flex; gap: 10px;">
                <button class="btn" onclick="downloadPDF()" style="background: white; color: #667eea; font-weight: 600; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn" onclick="window.print()" style="background: rgba(255,255,255,0.2); color: white; font-weight: 600; border: 2px solid white; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
            <div style="position: relative; z-index: 1;">
                <p style="color: rgba(255,255,255,0.95); margin-bottom: 8px; font-size: 1rem; font-weight: 500;"><i class="fas fa-calendar-week"></i> Weekly Progress Report</p>
                <h1 style="font-size: 2.5rem; margin-bottom: 12px; color: white; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);" id="childName">Loading...</h1>
                <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">
                    <span id="reportPeriod">-</span> | Generated: <span id="generatedDate">-</span>
                </p>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card primary animate-fadeInUp">
                <div class="stat-icon primary"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-content">
                    <h3 id="totalSessions">0</h3>
                    <p>Sessions This Week</p>
                </div>
            </div>
            <div class="stat-card success animate-fadeInUp delay-100">
                <div class="stat-icon success"><i class="fas fa-clock"></i></div>
                <div class="stat-content">
                    <h3 id="totalHours">0h</h3>
                    <p>Total Hours</p>
                </div>
            </div>
            <div class="stat-card warning animate-fadeInUp delay-200">
                <div class="stat-icon warning"><i class="fas fa-chart-line"></i></div>
                <div class="stat-content">
                    <h3 id="avgProgress">0%</h3>
                    <p>Avg Progress</p>
                </div>
            </div>
            <div class="stat-card info animate-fadeInUp delay-300">
                <div class="stat-icon info"><i class="fas fa-star"></i></div>
                <div class="stat-content">
                    <h3 id="improvements">0</h3>
                    <p>Improvements</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div class="card animate-fadeInUp delay-400">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-chart-radar"></i> Domain Performance</h3>
                </div>
                <div class="card-body">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
            <div class="card animate-fadeInUp delay-500">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-chart-bar"></i> Daily Progress</h3>
                </div>
                <div class="card-body">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Domain Details -->
        <div class="card animate-fadeInUp delay-600" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3 style="margin: 0;"><i class="fas fa-layer-group"></i> Domain Analysis</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <!-- Communication -->
                    <div class="domain-card">
                        <div class="domain-icon rating-good"><i class="fas fa-comments"></i></div>
                        <h4 style="margin-bottom: 10px;">Communication</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill success" style="width: 72%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">72% - Good Progress</p>
                    </div>
                    <!-- Emotional -->
                    <div class="domain-card">
                        <div class="domain-icon rating-average"><i class="fas fa-heart"></i></div>
                        <h4 style="margin-bottom: 10px;">Emotional</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill warning" style="width: 65%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">65% - Average</p>
                    </div>
                    <!-- Social -->
                    <div class="domain-card">
                        <div class="domain-icon rating-good"><i class="fas fa-users"></i></div>
                        <h4 style="margin-bottom: 10px;">Social</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill success" style="width: 78%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">78% - Good Progress</p>
                    </div>
                    <!-- Behavior -->
                    <div class="domain-card">
                        <div class="domain-icon rating-average"><i class="fas fa-hand-peace"></i></div>
                        <h4 style="margin-bottom: 10px;">Behavior</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill warning" style="width: 68%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">68% - Average</p>
                    </div>
                    <!-- Cognitive -->
                    <div class="domain-card">
                        <div class="domain-icon rating-good"><i class="fas fa-brain"></i></div>
                        <h4 style="margin-bottom: 10px;">Cognitive</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill success" style="width: 75%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">75% - Good Progress</p>
                    </div>
                    <!-- Sensory -->
                    <div class="domain-card">
                        <div class="domain-icon rating-needs-work"><i class="fas fa-hand-sparkles"></i></div>
                        <h4 style="margin-bottom: 10px;">Sensory</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill danger" style="width: 55%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">55% - Needs Focus</p>
                    </div>
                    <!-- Daily Living -->
                    <div class="domain-card">
                        <div class="domain-icon rating-good"><i class="fas fa-home"></i></div>
                        <h4 style="margin-bottom: 10px;">Daily Living</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill success" style="width: 82%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">82% - Excellent</p>
                    </div>
                    <!-- Participation -->
                    <div class="domain-card">
                        <div class="domain-icon rating-average"><i class="fas fa-star"></i></div>
                        <h4 style="margin-bottom: 10px;">Participation</h4>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill warning" style="width: 70%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">70% - Average</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary & Recommendations -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div class="card animate-fadeInUp delay-700">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-clipboard-check"></i> Weekly Summary</h3>
                </div>
                <div class="card-body">
                    <div class="summary-box">
                        <h4 style="color: var(--success-color); margin-bottom: 10px;"><i class="fas fa-arrow-up"></i> Strengths</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">‚úÖ Daily Living Skills showing excellent progress</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">‚úÖ Social interaction improved significantly</li>
                            <li style="padding: 8px 0;">‚úÖ Communication consistency maintained</li>
                        </ul>
                    </div>
                    <div class="summary-box">
                        <h4 style="color: var(--warning-color); margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Areas for Focus</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">‚ö†Ô∏è Sensory processing needs more attention</li>
                            <li style="padding: 8px 0;">‚ö†Ô∏è Emotional regulation during transitions</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card animate-fadeInUp delay-800">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-lightbulb"></i> Recommendations</h3>
                </div>
                <div class="card-body">
                    <div class="recommendation-item">
                        <h4 style="margin-bottom: 8px;"><i class="fas fa-hand-sparkles" style="color: var(--primary-color);"></i> Sensory Activities</h4>
                        <p style="color: var(--text-secondary);">Incorporate more sensory integration activities, such as textured play and proprioceptive exercises.</p>
                    </div>
                    <div class="recommendation-item">
                        <h4 style="margin-bottom: 8px;"><i class="fas fa-heart" style="color: var(--primary-color);"></i> Emotional Support</h4>
                        <p style="color: var(--text-secondary);">Use visual schedules and transition warnings to help with emotional regulation during activity changes.</p>
                    </div>
                    <div class="recommendation-item">
                        <h4 style="margin-bottom: 8px;"><i class="fas fa-home" style="color: var(--primary-color);"></i> Home Practice</h4>
                        <p style="color: var(--text-secondary);">Continue reinforcing daily living skills at home with structured routines and positive reinforcement.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Log -->
        <div class="card animate-fadeInUp delay-900">
            <div class="card-header">
                <h3 style="margin: 0;"><i class="fas fa-list"></i> Session Log</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Activities</th>
                                <th>Overall Rating</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="sessionTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading sessions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Report Actions -->
        <div style="text-align: center; margin-top: 30px;" class="no-print">
            <button class="btn btn-primary btn-lg" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button class="btn btn-secondary btn-lg" onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> Download PDF
            </button>
            <button class="btn btn-outline btn-lg" onclick="emailReport()">
                <i class="fas fa-envelope"></i> Email Report
            </button>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');
        const childId = window.location.pathname.split('/').pop();

        if (!token) {
            window.location.href = '/login';
        }

        // Set dashboard link based on user type
        document.getElementById('dashboardLink').href = userType === 'doctor' ? '/doctor/dashboard' : '/parent/dashboard';

        // Set dates
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        document.getElementById('reportPeriod').textContent = `${weekAgo.toLocaleDateString()} - ${today.toLocaleDateString()}`;
        document.getElementById('generatedDate').textContent = today.toLocaleDateString();

        // Load report data
        async function loadReport() {
            try {
                // Load child info
                const childRes = await fetch(`/api/child/${childId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (childRes.ok) {
                    const child = await childRes.json();
                    document.getElementById('childName').textContent = child.name;
                }

                // Load weekly report
                const reportRes = await fetch(`/api/reports/weekly/${childId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (reportRes.ok) {
                    const report = await reportRes.json();
                    
                    // Update stats
                    document.getElementById('totalSessions').textContent = report.total_sessions || 0;
                    const hours = Math.round((report.total_duration || 0) / 60);
                    document.getElementById('totalHours').textContent = `${hours}h`;
                    
                    // Calculate average progress from domain averages
                    const domainScores = Object.values(report.domain_averages || {}).filter(v => v > 0);
                    const avgProgress = domainScores.length > 0 ? Math.round(domainScores.reduce((a, b) => a + b, 0) / domainScores.length) : 0;
                    document.getElementById('avgProgress').textContent = `${avgProgress}%`;
                    
                    // Count improvements
                    const improvements = Object.values(report.improvement_trends || {}).filter(v => v === 'improving').length;
                    document.getElementById('improvements').textContent = improvements;

                    // Render sessions
                    if (report.session_summaries && report.session_summaries.length > 0) {
                        const tableHtml = report.session_summaries.map(s => `
                            <tr>
                                <td>${new Date(s.date).toLocaleDateString()}</td>
                                <td>${s.duration} min</td>
                                <td>${(s.activities || '-').substring(0, 40)}${s.activities && s.activities.length > 40 ? '...' : ''}</td>
                                <td><span class="badge badge-success">Good</span></td>
                                <td>${(s.notes || '-').substring(0, 30)}${s.notes && s.notes.length > 30 ? '...' : ''}</td>
                            </tr>
                        `).join('');
                        document.getElementById('sessionTable').innerHTML = tableHtml;
                    } else {
                        document.getElementById('sessionTable').innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                    <i class="fas fa-calendar-times" style="font-size: 1.5rem; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                                    No sessions recorded this week
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    document.getElementById('sessionTable').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">
                                <i class="fas fa-exclamation-circle" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                                Failed to load sessions
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('sessionTable').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">
                            <i class="fas fa-exclamation-circle" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                            Error loading sessions
                        </td>
                    </tr>
                `;
            }

            // Initialize charts
            initCharts();
        }

        function initCharts() {
            // Radar Chart
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['Communication', 'Emotional', 'Social', 'Behavior', 'Cognitive', 'Sensory', 'Daily Living', 'Participation'],
                    datasets: [{
                        label: 'This Week',
                        data: [72, 65, 78, 68, 75, 55, 82, 70],
                        fill: true,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgb(102, 126, 234)',
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff'
                    }, {
                        label: 'Last Week',
                        data: [68, 60, 72, 65, 70, 52, 78, 66],
                        fill: true,
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        borderColor: 'rgb(17, 153, 142)',
                        pointBackgroundColor: 'rgb(17, 153, 142)',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Bar Chart
            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Progress Score',
                        data: [68, 72, 70, 75, 78, 74, 80],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.7)',
                            'rgba(102, 126, 234, 0.7)',
                            'rgba(102, 126, 234, 0.7)',
                            'rgba(102, 126, 234, 0.7)',
                            'rgba(102, 126, 234, 0.7)',
                            'rgba(102, 126, 234, 0.7)',
                            'rgba(17, 153, 142, 0.7)'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function downloadPDF() {
            showToast('Generating PDF...', 'info');
            
            const childName = document.getElementById('childName').textContent;
            const reportPeriod = document.getElementById('reportPeriod').textContent;
            const generatedDate = document.getElementById('generatedDate').textContent;
            const totalSessions = document.getElementById('totalSessions').textContent;
            const totalHours = document.getElementById('totalHours').textContent;
            const avgProgress = document.getElementById('avgProgress').textContent;
            const improvements = document.getElementById('improvements').textContent;
            const doctorName = localStorage.getItem('userName') || 'Doctor';
            
            // Get session data from table
            const sessionRows = document.querySelectorAll('#sessionTable tr');
            let sessionsHtml = '';
            sessionRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    sessionsHtml += `
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${cells[0]?.textContent || '-'}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${cells[1]?.textContent || '-'}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${cells[2]?.textContent || '-'}</td>
                        </tr>
                    `;
                }
            });
            
            if (!sessionsHtml) {
                sessionsHtml = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #6b7280;">No sessions recorded this week</td></tr>';
            }
            
            // Create professional invoice-style PDF content
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; background: white;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üåà</div>
                                <div>
                                    <h1 style="margin: 0; font-size: 24px; color: #1a1a2e; font-weight: 700;">TherapyTrack</h1>
                                    <p style="margin: 0; font-size: 12px; color: #6b7280;">Autism Therapy Management System</p>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0 0 5px 0; font-size: 20px; color: #667eea; font-weight: 600;">WEEKLY PROGRESS REPORT</h2>
                            <p style="margin: 0; font-size: 12px; color: #6b7280;">Report #WR-${Date.now().toString().slice(-6)}</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Generated: ${generatedDate}</p>
                        </div>
                    </div>
                    
                    <!-- Patient & Doctor Info -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; gap: 40px;">
                        <div style="flex: 1; background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                            <h3 style="margin: 0 0 12px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px;">Patient Information</h3>
                            <p style="margin: 0 0 6px 0; font-size: 18px; font-weight: 600; color: #1a1a2e;">${childName}</p>
                            <p style="margin: 0; font-size: 13px; color: #6b7280;">Report Period: ${reportPeriod}</p>
                        </div>
                        <div style="flex: 1; background: #f8fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #11998e;">
                            <h3 style="margin: 0 0 12px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px;">Therapist Information</h3>
                            <p style="margin: 0 0 6px 0; font-size: 18px; font-weight: 600; color: #1a1a2e;">Dr. ${doctorName}</p>
                            <p style="margin: 0; font-size: 13px; color: #6b7280;">Licensed Therapy Specialist</p>
                        </div>
                    </div>
                    
                    <!-- Summary Stats -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #1a1a2e; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Weekly Summary</h3>
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1; background: linear-gradient(135deg, #667eea15, #667eea05); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #667eea30;">
                                <p style="margin: 0; font-size: 28px; font-weight: 700; color: #667eea;">${totalSessions}</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Sessions</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #11998e15, #11998e05); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #11998e30;">
                                <p style="margin: 0; font-size: 28px; font-weight: 700; color: #11998e;">${totalHours}</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Total Hours</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #f39c1215, #f39c1205); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #f39c1230;">
                                <p style="margin: 0; font-size: 28px; font-weight: 700; color: #f39c12;">${avgProgress}</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Avg Progress</p>
                            </div>
                            <div style="flex: 1; background: linear-gradient(135deg, #3b82f615, #3b82f605); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #3b82f630;">
                                <p style="margin: 0; font-size: 28px; font-weight: 700; color: #3b82f6;">${improvements}</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Improvements</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sessions Table -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #1a1a2e; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Session Details</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Date</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Duration</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Activities</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessionsHtml}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Progress Assessment -->
                    <div style="margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #1a1a2e; font-weight: 600;">Progress Assessment</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Communication Skills</p>
                                <div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 75%; border-radius: 10px;"></div>
                                </div>
                            </div>
                            <div>
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Social Skills</p>
                                <div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #11998e, #38ef7d); height: 100%; width: 82%; border-radius: 10px;"></div>
                                </div>
                            </div>
                            <div>
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Behavioral Management</p>
                                <div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #f39c12, #f1c40f); height: 100%; width: 70%; border-radius: 10px;"></div>
                                </div>
                            </div>
                            <div>
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Cognitive Development</p>
                                <div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #3b82f6, #60a5fa); height: 100%; width: 78%; border-radius: 10px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">This report is generated by TherapyTrack System</p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">For questions, contact your therapy provider.</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="border-top: 1px solid #1a1a2e; padding-top: 8px; width: 200px;">
                                    <p style="margin: 0; font-size: 12px; font-weight: 600; color: #1a1a2e;">Dr. ${doctorName}</p>
                                    <p style="margin: 2px 0 0 0; font-size: 11px; color: #6b7280;">Authorized Signature</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `Weekly_Report_${childName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };
            
            try {
                await html2pdf().set(opt).from(pdfContent).save();
                showToast('PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('Error generating PDF. Please try again.', 'error');
            }
        }

        function emailReport() {
            showToast('Email report feature coming soon!', 'info');
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        loadReport();
    </script>
</body>
</html>
