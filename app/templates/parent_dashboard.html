<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Dashboard - TherapyTrack</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <div class="logo-icon">ðŸŒˆ</div>
                <span class="logo-text">TherapyTrack</span>
            </a>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/parent/dashboard" class="active"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li><a href="#" id="viewReportsLink"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
            <li><a href="#"><i class="fas fa-bell"></i><span>Notifications</span></a></li>
            <li><a href="#"><i class="fas fa-user"></i><span>My Profile</span></a></li>
            <li style="margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Welcome, <span id="parentName">Parent</span>!</h1>
                <p class="page-subtitle">Track your child's therapy progress and achievements</p>
            </div>
        </div>

        <!-- Child Access Code Entry (if no child linked) -->
        <div class="card animate-fadeInUp" id="linkChildCard" style="display: none; margin-bottom: 30px;">
            <div class="card-body" style="padding: 40px; text-align: center;">
                <div style="width: 80px; height: 80px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem;">
                    <i class="fas fa-link" style="color: white;"></i>
                </div>
                <h2 style="margin-bottom: 10px;">Link Your Child</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
                    Enter the unique child code provided by your doctor to access your child's therapy progress and reports.
                </p>
                <form id="linkChildForm" style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-key"></i></span>
                            <input type="text" id="childCode" class="form-control" placeholder="Enter Child Code (e.g., P-2025-0012)" required pattern="P-[0-9]{4}-[0-9]{4}">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-link"></i> Link Child
                    </button>
                </form>
            </div>
        </div>

        <!-- Child Overview (when linked) -->
        <div id="childOverview" style="display: none;">
            <!-- Child Info Card -->
            <div class="card animate-fadeInUp" style="margin-bottom: 30px;">
                <div class="card-body" style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 30px; align-items: center;">
                        <div class="avatar avatar-lg" id="childAvatar" style="width: 100px; height: 100px; font-size: 2.5rem;">C</div>
                        <div>
                            <h2 style="margin-bottom: 5px;" id="childName">-</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                <i class="fas fa-user-md"></i> Therapy with <span id="doctorName">-</span>
                            </p>
                            <div style="display: flex; gap: 20px;">
                                <span class="badge badge-primary"><i class="fas fa-birthday-cake"></i> <span id="childAge">-</span> years old</span>
                                <span class="badge badge-success"><i class="fas fa-calendar-check"></i> <span id="totalSessions">0</span> sessions completed</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: var(--gradient-primary); border-radius: 15px; padding: 20px 30px; color: white; text-align: center;">
                                <p style="opacity: 0.9; font-size: 0.9rem;">Overall Progress</p>
                                <h2 style="font-size: 2.5rem; margin: 5px 0;" id="overallProgress">0%</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="stat-card primary animate-fadeInUp delay-100">
                    <div class="stat-icon primary"><i class="fas fa-calendar-week"></i></div>
                    <div class="stat-content">
                        <h3 id="weekSessions">0</h3>
                        <p>Sessions This Week</p>
                    </div>
                </div>
                <div class="stat-card success animate-fadeInUp delay-200">
                    <div class="stat-icon success"><i class="fas fa-star"></i></div>
                    <div class="stat-content">
                        <h3 id="improvements">0</h3>
                        <p>Areas Improved</p>
                    </div>
                </div>
                <div class="stat-card warning animate-fadeInUp delay-300">
                    <div class="stat-icon warning"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-content">
                        <h3 id="goalsAchieved">0</h3>
                        <p>Goals Achieved</p>
                    </div>
                </div>
                <div class="stat-card info animate-fadeInUp delay-400">
                    <div class="stat-icon info"><i class="fas fa-trophy"></i></div>
                    <div class="stat-content">
                        <h3 id="milestones">0</h3>
                        <p>Milestones Reached</p>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div class="card animate-fadeInUp delay-500">
                    <div class="card-header">
                        <h3 style="margin: 0;"><i class="fas fa-chart-radar"></i> Development Domains</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="domainChart"></canvas>
                    </div>
                </div>
                <div class="card animate-fadeInUp delay-600">
                    <div class="card-header">
                        <h3 style="margin: 0;"><i class="fas fa-chart-line"></i> Weekly Progress</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Domain Progress Bars -->
            <div class="card animate-fadeInUp delay-700" style="margin-bottom: 30px;">
                <div class="card-header">
                    <h3 style="margin: 0;"><i class="fas fa-tasks"></i> Domain Progress Details</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-comments"></i> Communication</span>
                                    <span class="progress-value">72%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill primary" style="width: 72%;"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-heart"></i> Emotional</span>
                                    <span class="progress-value">65%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill success" style="width: 65%;"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-users"></i> Social</span>
                                    <span class="progress-value">78%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill warning" style="width: 78%;"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-hand-peace"></i> Behavior</span>
                                    <span class="progress-value">68%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill info" style="width: 68%;"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-brain"></i> Cognitive</span>
                                    <span class="progress-value">75%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill primary" style="width: 75%;"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-hand-sparkles"></i> Sensory</span>
                                    <span class="progress-value">60%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill success" style="width: 60%;"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-home"></i> Daily Living</span>
                                    <span class="progress-value">82%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill warning" style="width: 82%;"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span><i class="fas fa-star"></i> Participation</span>
                                    <span class="progress-value">70%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill info" style="width: 70%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Sessions -->
            <div class="card animate-fadeInUp delay-800">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;"><i class="fas fa-history"></i> Recent Sessions</h3>
                    <a href="#" class="btn btn-ghost btn-sm">View All</a>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="sessionsList">
                        <!-- Sessions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');
        const userName = localStorage.getItem('userName');

        if (!token || userType !== 'parent') {
            window.location.href = '/login';
        }

        document.getElementById('parentName').textContent = userName || 'Parent';

        // Check if parent has linked children from server
        let linkedChildId = null;

        async function initializeDashboard() {
            try {
                // Fetch linked children from server
                const response = await fetch('/api/parent/children', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const children = await response.json();
                    
                    if (children.length > 0) {
                        // Use first linked child
                        linkedChildId = children[0].id;
                        localStorage.setItem('linkedChildId', linkedChildId);
                        document.getElementById('linkChildCard').style.display = 'none';
                        document.getElementById('childOverview').style.display = 'block';
                        loadChildData(linkedChildId);
                    } else {
                        document.getElementById('linkChildCard').style.display = 'block';
                        document.getElementById('childOverview').style.display = 'none';
                    }
                } else {
                    document.getElementById('linkChildCard').style.display = 'block';
                    document.getElementById('childOverview').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching children:', error);
                document.getElementById('linkChildCard').style.display = 'block';
                document.getElementById('childOverview').style.display = 'none';
            }
        }

        // Initialize dashboard
        initializeDashboard();

        // Link child form
        document.getElementById('linkChildForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('childCode').value.trim();
            
            try {
                const response = await fetch('/api/parent/link-child', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ child_code: code })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('linkedChildId', data.child_id);
                    linkedChildId = data.child_id;
                    showToast('Child linked successfully!', 'success');
                    document.getElementById('linkChildCard').style.display = 'none';
                    document.getElementById('childOverview').style.display = 'block';
                    loadChildData(linkedChildId);
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Invalid child code', 'error');
                }
            } catch (error) {
                showToast('Failed to link child', 'error');
            }
        });

        async function loadChildData(childId) {
            try {
                // Load child info
                const childRes = await fetch(`/api/child/${childId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (childRes.ok) {
                    const child = await childRes.json();
                    document.getElementById('childName').textContent = child.name;
                    document.getElementById('childAvatar').textContent = child.name[0];
                    document.getElementById('childAge').textContent = child.age;
                    document.getElementById('doctorName').textContent = child.doctor_name || 'Your Doctor';
                    document.getElementById('viewReportsLink').href = `/reports/weekly/${childId}`;
                }

                // Load sessions
                const sessionsRes = await fetch(`/api/therapy/logs/${childId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (sessionsRes.ok) {
                    const sessions = await sessionsRes.json();
                    document.getElementById('totalSessions').textContent = sessions.length;
                    
                    // Calculate week sessions
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const weekSessions = sessions.filter(s => new Date(s.session_date) >= weekAgo);
                    document.getElementById('weekSessions').textContent = weekSessions.length;

                    // Render sessions list
                    if (sessions.length > 0) {
                        const sessionsHtml = sessions.slice(0, 5).map(session => `
                            <div class="session-item" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin-bottom: 5px;">${new Date(session.session_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                            <i class="fas fa-clock"></i> ${session.duration_minutes} minutes
                                        </p>
                                    </div>
                                    <span class="badge badge-success"><i class="fas fa-check"></i> Completed</span>
                                </div>
                                <p style="margin-top: 10px; color: var(--text-secondary);">${session.activities_performed.substring(0, 100)}...</p>
                                ${session.parent_notes ? `<p style="margin-top: 10px; padding: 10px; background: var(--bg-light); border-radius: 8px; font-style: italic;"><i class="fas fa-comment"></i> ${session.parent_notes}</p>` : ''}
                            </div>
                        `).join('');
                        document.getElementById('sessionsList').innerHTML = sessionsHtml;
                    } else {
                        document.getElementById('sessionsList').innerHTML = `
                            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p>No sessions recorded yet</p>
                            </div>
                        `;
                    }

                    // Initialize charts
                    initCharts();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function initCharts() {
            // Domain Radar Chart
            const domainCtx = document.getElementById('domainChart').getContext('2d');
            new Chart(domainCtx, {
                type: 'radar',
                data: {
                    labels: ['Communication', 'Emotional', 'Social', 'Behavior', 'Cognitive', 'Sensory', 'Daily Living', 'Participation'],
                    datasets: [{
                        label: 'Current Progress',
                        data: [72, 65, 78, 68, 75, 60, 82, 70],
                        fill: true,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgb(102, 126, 234)',
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(102, 126, 234)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Progress Line Chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Overall Progress',
                        data: [55, 62, 68, 71],
                        fill: true,
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        borderColor: '#11998e',
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Set overall progress
            document.getElementById('overallProgress').textContent = '71%';
            document.getElementById('improvements').textContent = '5';
            document.getElementById('goalsAchieved').textContent = '3';
            document.getElementById('milestones').textContent = '2';
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });
    </script>
</body>
</html>
